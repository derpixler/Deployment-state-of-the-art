<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Deployment - state of the art - #wcber15 #dollertyp #DevOps #WordPress</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/typed.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">

				<section data-background="img/wcber_slide_1.jpg">
					<h1>Deployment</h1>
					<h5>state of the art </h5>
                    <h5><span class="fragment">#wcber</span> <span class="fragment">#dollertyp</span> <span class="fragment">#DevOps</span> <span class="fragment">#WordPress</span></h5>
				</section>

				<section data-background="img/wcber_slide_2.jpg">
					<h1>Hallo, mein Name ist </h1>
					<h4>René Reimann @DerPixler</h4>
					<p>&nbsp;</p>
					<ul>
						<li class="fragment">WordPress Fanboy seit 2006</li>
						<li class="fragment">Mediengestalter für Digital- & Printmedien</li>
						<li class="fragment">Senior Fullstack Web Developer</li>
						<li class="fragment">Podcaster - wp-sofa.de</li>
					</ul>

				</section>

				<section data-background="img/wcber_slide_3.jpg">
					<h2>Was werde ich jetzt erzählen</h2>

					<ul>
						<li class="fragment">Definition Deployment</li>
						<li class="fragment">Einfaches Deployment</li>
						<li class="fragment">Automatisches Deployment</li>
						<li class="fragment">Deployment Workflows</li>
						<li class="fragment">Deployment Arichtekturen</li>
					</ul>

					<aside class="notes">
						<ul>
							<li>Begriffserklärung Deployment</li>
							<li>FTP/SFTP/SCP</li>
							<li>Automatisches Deployment
							<ul>
								<li>Erklärung, (was beduetet Automatisch evl. vergleich zu Pizza oder Post einbauen)</li>
								<li>Möglichkeiten: Native & Mit deployment tools</li>
							</ul>
							</li>
							<li>Beispiel Workflow mit WordPress und Deployer</li>
							<li>Realworld Beispiel mit mehreren Stages</li>
						</ul>
					</aside>

				</section>

				<section data-background="img/wcber_slide_4.jpg">
					<section>
						<h2>Deployment = <span class="fragment">Verteilen</span></h2>
						<p class="fragment">Etwas verteilen, Dinge gleicher oder ähnlicher Art an mehrere Zeile austeilen.</p>

						<aside class="notes">
							<p>Etwas verteilt; Dinge gleicher oder ähnlicher Art an mehrere Positionen geben oder austeilen.</p>
						</aside>

					</section>
					<section data-background="img/wcber_slide_4_1.jpg">

                        <h2>Wie wir Dinge verteilen?</h2>

					</section>
					<section>
						<h2>Drag & Drop uploads</h2>
						<div style="border: 6px dotted #B2D6FF;padding: 10%;background: rgba(178, 214, 255, 0.16);">Drop your stuff here!</div>

						<aside class="notes">
							<ul>
								<li>Medien werden oft per drag & drop verteilt.</li>
								<li>die einfachste Möglichkeit</li>
							</ul>
						</aside>
					</section>
					<section>
						<h2>Manuelle uploads</h2>
						<p>FTP & Co.</p>
						<table  width="100%" style="font-size: 20px">
							<colgroup>
								<col width="50%"/>
								<col width="50%"/>
							</colgroup>
							<tr>
								<td>Local</td>
								<td>Remote</td>
							</tr>
							<tr>
								<td style="border: 6px dotted #B2D6FF;background: rgba(178, 214, 255, 0.16);" valign="top">
									<div>drwxr-xr-x  .</div>
									<div>drwxr-xr-x  ..</div>
									<div>drwxr-xr-x  index.html</div>
								</td>
								<td style="border: 6px dotted #B2D6FF;padding:10%; background: rgba(178, 214, 255, 0.16);">
									drag your file here!
								</td>
							</tr>
						</table>

						<aside class="notes">
							<p>Datei für Datei!</p>
							<p>Gefahr: dateien können überschreiben oder gelöscht werden, kein überblick über veränderungen (außer datum)</p>

						</aside>
					</section>
					<section>
						<h2>Via Commandline (CLI)</h2>

						<div class="fragment">
							<h5>SFTP - Secure File Transfer Protocol</h5>
							<pre><code class="hljs">sftp -P 42022 ~/development/db_dump rene.reimann@10.111.26.61:/home/dev_db_sync/db_dump/cts_seo.sql</code></pre>
						</div>
						<div class="fragment">
							<h5>SCP - Secure Copy</h5>
							<pre><code class="hljs">scp -P 42022 ~/development/db_dump rene.reimann@10.111.26.61:/home/dev_db_sync/db_dump/cts_seo.sql</code></pre>
						</div>
						<aside class="notes">

						</aside>
					</section>

				</section>

				<section data-background="img/wcber_slide_5.jpg">
					<section>
						<h1>Deployment like a Pro</h1>
					</section>
					<section>
						<h3>Deployment Möglichkeiten</h3>
						<h5 class="fragment">easy</h5>
						<h5 class="fragment">semieasy</h5>
						<h5 class="fragment">fullstack</h5>
					</section>
					<section>
						<h1>Deployment easy</h1>
						<h5 class="fragment">FTP-Programme mit Sync-Function: Transmit (mac)</h5>
						<img class="fragment" src="img/transmit.png" style="border:0;width: 650px;background: none;box-shadow:inherit"/>

					</section>
					<section>

						<h5>Commandline Tools: rsync</h5>
						<pre class="fragment"><code class="hljs">$ rsync -a -e ssh root@192.168.0.100:/folder1/ /folder2/</code></pre>
					</section>

					<section>

						<h2>Vorteile</h2>
						<ul>
							<li class="fragment">Sehr einfach in der Hanhabung</li>
							<li class="fragment">Keine tiefergehendes Wissen nötig.</li>
						</ul>

					</section>

					<section>

						<h2>Nachteile</h2>
						<ul>
							<li class="fragment">Wenig Kontrolle</li>
							<li class="fragment">Rollback Kompliziert</li>
							<li class="fragment">Fehlerquote hoch</li>
						</ul>

					</section>

					<section>
						<h1>Deployment semieasy</h1>
						<h5 class="fragment">Vorbereitung: <span class="fragment">mit Composer Projekte bauen</span></h5>
						<pre class="fragment" style="font-size: 10px"><code class="hljs">{
 {
 "name": "WordPress Playground",
 "description": "Build a Wordpress Project",
 "license": "GPL-3.0+",
 "homepage": "https://github.com/derpixler/Deployment-state-of-the-art",
 "authors": [ {
    "name": "Rene Reimann",
    "homepage": "http://rene-reimann.de",
    "email": "info@rene-reimann.de",
    "role": "Developer"
 	} ],
 "repositories": [ {
    "type": "composer",
    "url": "https://wpackagist.org"
 	} ],
 "require": {
    "php": ">=5.3.0",
    "johnpbloch/wordpress-core-installer": "~0.2",
    "johnpbloch/wordpress-core": "4.*",
    "wpackagist-plugin/stream": "3.2.0",
    "wpackagist-plugin/backwpup": "3.3.*"
 },
 "extra": {
    "wordpress-install-dir": "html/wp-core",
	"installer-paths": {
    	"html/wp-content/plugins/{$name}/": ["type:wordpress-plugin"],
    	"html/wp-content/themes/{$name}/": ["type:wordpress-theme"]
	}
 },
 "scripts" : {
    "post-install-cmd": "./prepare.sh",
	"post-update-cmd": "./prepare.sh"
 }
}
}</code></pre>

					</section>

					<section>
					<pre><code class="hljs">
{
 "name": "WordPress Playground",
 "description": "Build a Wordpress Project",
 "license": "GPL-3.0+",
 "homepage": "https://github.com/derpixler/Deployment-state-of-the-art",
 "authors": [ {
    "name": "Rene Reimann",
    "homepage": "http://rene-reimann.de",
    "email": "info@rene-reimann.de",
    "role": "Developer"
 	} ],
						</code></pre>

					</section>

					<section>
					<pre><code class="hljs">"repositories": [ {
    "type": "composer",
    "url": "https://wpackagist.org"
 	} ],
 "require-dev": {
    "wpackagist-plugin/stream": "3.2.0"
 },
 "require": {
    "johnpbloch/wordpress-core-installer": "~0.2",
    "johnpbloch/wordpress-core": "4.*",
    "wpackagist-plugin/stream": "3.2.0",
    "wpackagist-plugin/backwpup": "3.3.*"
 },</code></pre>

					</section>

					<section>
					<pre><code class="hljs">

 "extra": {
    "wordpress-install-dir": "html/wp-core",
    "installer-paths": {
        "html/wp-content/plugins/{$name}/": ["type:wordpress-plugin"],
        "html/wp-content/themes/{$name}/": ["type:wordpress-theme"]
	}
 },
 "scripts" : {
    "post-install-cmd": "./prepare.sh",
	"post-update-cmd": "./prepare.sh"
}
						</code></pre>

					</section>

					<section>
						<h5>Projekt mit Composer installieren & aktualisieren</span></h5>
						<pre class="fragment terminal type-wrap" style="font-size: 20px">Last login: Sat May 13 12:20:04 on wcber13052017
rener$@local:~ $<span class="fragment"> ssh rene@123.456.78.910</span>
<span class="fragment">rene@server: $ cd /var/www/</span>
<span class="fragment">rene@server: $ git clone https://github.com/...easy-wordpress..</span>
<span class="fragment">rene@server: $ <span class="fragment">composer install</span></span>
<span class="fragment"><span class="highlight">Loading composer repositories with package information</span></span>
<span class="fragment"><span class="highlight">Updating dependencies (including require-dev)</span></span>
<span class="fragment">  - Installing <span class="highlight">composer/installers</span> (<span class="highlight yellow">v1.3.0</span>)
    Loading from cache
</span>
<span class="fragment">  - Installing <span class="highlight">johnpbloch/wordpress-core-installer</span> (<span class="highlight yellow">0.2.1</span>)
    Loading from cache
</span>
<span class="fragment">  - Installing <span class="highlight">johnpbloch/wordpress-core</span> (<span class="highlight yellow">4.7.4.1</span>)
    Cloning b58505c58043c5e569b5d119878f8e8c1d5f51e4
</span>
<span class="fragment">  - Installing <span class="highlight">wpackagist-plugin/stream</span> (<span class="highlight yellow">3.2.0</span>)
    Downloading: 100%
</span>
<span class="fragment">  - Installing <span class="highlight">wpackagist-plugin/backwpup</span> (<span class="highlight yellow">3.3.7</span>)
    Loading from cache
</span>
					</section>

					<section>
					<pre class="terminal type-wrap" style="font-size: 20px">
<span class="highlight">Writing lock file</span>
<span class="fragment"><span class="highlight">Generating autoload files</span></span>

<span class="fragment">> ./prepare.sh
  - Copy <span class="highlight">wp-config.php.dist</span> -> <span class="highlight">vagrant/html/wp-config.php</span>
    Files copied	</span>
					</pre>
						<p class="fragment" style="font-size: 25px">https://github.com/derpixler/easy-wordpress-composer-install</p>
					</section>

					<section>
						<h5>Die Installation</h5>
						<pre class="fragment terminal type-wrap" style="font-size: 20px">
-rw-r--r--@ 1 renereimann  staff   946 13 Mai 12:52 <span class="highlight">composer.json</span>
-rw-r--r--  1 renereimann  staff  8617 13 Mai 12:43 <span class="highlight">composer.lock</span>
-rwxr-xr-x@ 1 renereimann  staff   553 13 Mai 12:42 <span class="highlight">prepare.sh</span>
-rw-r--r--@ 1 renereimann  staff  2919 13 Mai 12:50 <span class="highlight">wp-config.php.dist</span>
drwxr-xr-x  5 renereimann  staff   170 13 Mai 12:43 <span class="highlight">html</span>
drwxr-xr-x  5 renereimann  staff   170 13 Mai 12:43 <span class="highlight">vendor</span>
<span class="fragment">
-rw-r--r--@  1 renereimann  staff  2853 13 Mai 06:43 <span class="highlight">wp-config.php</span>
drwxr-xr-x   3 renereimann  staff   102 13 Mai 06:43 <span class="highlight">wp-content</span>
drwxr-xr-x  22 renereimann  staff   748 13 Mai 06:43 <span class="highlight">wp-core</span>
</span>
					</pre>
					</section>

					<section>

						<h2>Vorteile</h2>
						<ul>
							<li class="fragment">Volle Kontrolle über Änderungen</li>
							<li class="fragment">Entwickler haben gleiche Versionen</li>
							<li class="fragment">Code kann verisoniert werden</li>
							<li class="fragment">Composer kann Builds & Tests ausführen</li>
						</ul>

					</section>

					<section>

						<h2>Nachteile</h2>
						<ul>
							<li class="fragment">Login auf dem Ziel Server nötig</li>
							<li class="fragment">Kein Rollback</li>
						</ul>

					</section>

					<section>
						<h1>Deployment full Stack</h1>
						<h3 class="fragment">Mit Deployment Tools</h3>
						<ul>
							<li class="fragment">Remote</li>
							<li class="fragment">Bessere Rechteverwaltung</li>
							<li class="fragment">Deploys werden Versioniert</li>
							<li class="fragment">Rollback</li>
							<li class="fragment">Continuous Integration</li>
							<li class="fragment">Staging</li>
						</ul>
					</section>

					<section>
						<h5>https://envoyer.io</h5>
						<img src="img/envoyer.png" style="border:0;width: 650px;background: none;box-shadow:inherit"/>
					</section>

					<section>
						<h5>https://de.atlassian.com/software/bamboo</h5>
						<img src="img/bamboo.png" style="border:0;width: 650px;background: none;box-shadow:inherit"/>
					</section>

					<section>
						<h3>https://deployer.org</h3>
						<h5 class="fragment">Deployer — Deployment tool for PHP</h5>
						<ul>
							<li class="fragment">Kostenlos</li>
							<li class="fragment">läuft lokal</li>
							<li class="fragment">Rezeptbasierend</li>
							<li class="fragment">Einfach</li>
						</ul>
					</section>

						<section>
						<h5>Lasst uns etwas deployen</h5>
						<div class="typecontent" id="line1">
							<span>dep deploy</span>
						</div>
						<pre class="terminal type-wrap">
Last login: Sat May 13 12:23:04 on wcber13052017
renereimann$@wcber:~ $ <span id="typed" style="white-space:pre;"></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:prepare</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:lock</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:backup_db</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:unittests</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:release</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:update_code</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:gulp</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:shared</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:vendors</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:migrate</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:warmup</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:symlink</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:update_wp_config</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:update_plugins_themes</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">deploy:unlock</span></span>
<span class="fragment"><span class="highlight">✔</span> Executing task <span class="highlight">cleanup</span></span>
<span class="fragment"><span class="highlight">Successfully deployed!</span>
					</pre>

					</section>

					<section>
						<div>
							<h5>Deploy auf einen Teststage</h5>
							<pre><code class="hljs">$ dep deploy test</code></pre>
						</div>
						<div class="fragment">
							<h5>Deploy auf einen Production</h5>
							<pre><code class="hljs">$ dep deploy production</code></pre>
						</div>
					</section>

					<section>
						<h1>Wie Funktioniert das?</h1>
						<h5 class="fragment">Die deployer.php</h5>
						<pre class="fragment" style="font-size: 20px"><code class="hljs">
namespace Deployer;
require 'recipe/common.php';

// Configuration
set('default_stage', 'test');
set('repository', 'git@github.com:derpixler/easy-wordpress-composer-install.git');
</code></pre>
					</section>

					<section>

<pre class="fragment" style="font-size: 20px"><code class="hljs">
server('production', 'p366988.mittwaldserver.info')
    ->user('p36698')
	->identityFile('~/.ssh/deployer_id_rsa.pub', '~/.ssh/deployer_id_rsa', '')
    ->set('deploy_path', '/home/www/p366988/deployment')
	->set('base_path', '/home/www/p366984')
	->set('sudo', FALSE)
	->set('stage', 'preview' )
	->set('DB_HOST', 'db4686.mydbserver.com' )
	->set('DB_USERNAME', 'p366988' )
	->set('DB_PASSWORD', 'usr_p366988_2' )
	->set('DB_DATABASE', 'Zhivimaq%960' );
</code></pre>
						<pre class="fragment" style="font-size: 20px"><code class="hljs">
server('test', '149.58.155.192')
    ->user('p36698')
	->identityFile('~/.ssh/deployer_id_rsa.pub', '~/.ssh/deployer_id_rsa', '')
    ->set('deploy_path', '/var/www/deployment')
	->set('base_path', '/var/www/')
	->set('sudo', TRUE)
	->set('stage', 'test' )
	->set('DB_HOST', 'localhost' )
	->set('DB_USERNAME', 'wordpress' )
	->set('DB_PASSWORD', 'IKiu2eiqu1shahghievoo9teidoc5ipp' )
	->set('DB_DATABASE', 'wordpress' );
</code></pre>
					</section>

					<section>

<pre class="fragment" style="font-size: 20px"><code class="hljs">
desc('Deploy your project');
task('deploy', [
	'deploy:start_info',
    'deploy:prepare',
    'deploy:lock',
	'deploy:backup_db',
    'deploy:release',
    'deploy:update_code',
    'deploy:shared',
    'deploy:writable',
    'deploy:vendors',
    'deploy:symlink',
    'deploy:clear_paths',
    'deploy:unlock',
    'cleanup',
    'success'
]);

after('deploy', 'success');
</code></pre>
						</section>

					<section>
<h5 class="fragment">Eigene Rezepte (tasks)</h5>
<pre class="fragment" style="font-size: 20px"><code class="hljs">
/**
 * Backup DB before deploy
 *
 * @siince 13.05.2017
 */
desc('Backup DB');
task('deploy:backup_db', function() {

	$link = run("readlink {{deploy_path}}/current")->toString();
    $currentRelease = substr($link, 0, 1) === '/' ? $link : get('deploy_path') . '/' . $link;

	$backup_dir = get('deploy_path') . '_db_backup';

	// Create the backup dir if it doesn't exist
	run( sprintf("if [ ! -d %s ]; then mkdir -p %s; fi", $backup_dir, $backup_dir ) );

    run(sprintf(
           'mysqldump -h%s -u%s -p%s %s | gzip > %s/%s.sql.gz',
		   get('DB_HOST'),
		   get('DB_USERNAME'),
		   get('DB_PASSWORD'),
		   get('DB_DATABASE'),
           $backup_dir,
           basename( $currentRelease )
       ));

});
</code></pre>
					</section>

					<section>
						<h5 >Eigene Rezepte (tasks)</h5>
						<pre style="font-size: 20px"><code class="hljs">

/**
 * restore last DB Backup after rollback
 *
 * @siince 13.05.2017
 */
desc('Rollback Deploy');
task('rollback', function() {

    $releases = get('releases_list');

    if (isset($releases[1])) {
        $releaseDir = "{{deploy_path}}/releases/{$releases[1]}";

        // Symlink to old release.
        run("cd {{deploy_path}} && {{bin/symlink}} $releaseDir current");

		// Remove release
        run("rm -rf {{deploy_path}}/releases/{$releases[0]}");

		$link = run("readlink {{deploy_path}}/current")->toString();
	    $currentRelease = substr($link, 0, 1) === '/' ? $link : get('deploy_path') . '/' . $link;

		$backup_dir = get('deploy_path') . 'db_backup';

	    run(sprintf(
	           'gunzip < %s/%s.sql.gz | mysql -h%s -u%s -p%s %s',
	           $backup_dir,
	           basename( $currentRelease ),
			   get('DB_HOST'),
			   get('DB_USERNAME'),
			   get('DB_PASSWORD'),
			   get('DB_DATABASE')
	       ));



        writeln("Rollback to `{$releases[1]}` release was successful.");

    } else {
        writeln("<comment>No more releases you can revert to.</comment>");
    }

} );
</code></pre>
					</section>


					<section data-background="img/wcber_slide_6.jpg">
						<h1>Fragen?</h1>
					</section>

					<section data-background="img/wcber_slide_7.jpg">
						<h1>Session Notes</h1>
						<div style="font-size: 30px">
							<p>https://github.com/derpixler/Deployment-state-of-the-art</p>
							<p>https://github.com/derpixler/easy-wordpress-composer-install</p>

							<p>&nbsp;</p>

							<p>www.rene-reimann.de</p>
							<p>https://twitter.com/DerPixler @DerPixler</p>
							<p>https://www.instagram.com/rene_reimann</p>
							<p>https://github.com/derpixler</p>
							<p>info@rene-reimann.de</p>
						</div>

					</section>

				</section>

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>
		<script src="js/typed.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
                    { src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
		<script>
            document.addEventListener('keypress', function(e){
                    var key = e.which || e.keyCode;
                    if (key === 119) { // 13 is enter
                        Typed.new("#typed", {
                            stringsElement: document.getElementById('line1'),
                            typeSpeed: 20,
                            backDelay: 500,
                            loop: false,
                            contentType: 'html', // or text
                            // defaults to null for infinite loop
                            loopCount: null,
                            callback: function(){ foo(); },
                            resetCallback: function() { newTyped(); }
                        });

                        var resetElement = document.querySelector('.reset');
                        if(resetElement) {
                            resetElement.addEventListener('click', function() {
                                document.getElementById('typed')._typed.reset();
                            });
                        }
                    }
            });

            function newTyped(){ /* A new typed object */ }

            function foo(){ console.log("Callback"); }

		</script>
	</body>
</html>
